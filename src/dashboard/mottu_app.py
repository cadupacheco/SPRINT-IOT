import streamlit as st
import cv2
import numpy as np
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
from PIL import Image
import sys
import os
import threading
import time
import json

# Adicionar src ao path
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from detection.moto_detector import MottuMotorcycleDetector
from detection.video_processor import MottuVideoProcessor
from simulation.iot_simulator import MottuIoTSimulator

def process_image_for_yolo(image):
    """
    Converte imagem para formato compat√≠vel com YOLO (3 canais RGB)
    """
    # Se imagem PIL, converter para numpy
    if hasattr(image, 'mode'):
        # Converter RGBA para RGB se necess√°rio
        if image.mode == 'RGBA':
            # Criar fundo branco
            background = Image.new('RGB', image.size, (255, 255, 255))
            background.paste(image, mask=image.split()[3])  # Usar canal alpha como m√°scara
            image = background
        elif image.mode != 'RGB':
            image = image.convert('RGB')
        
        # Converter PIL para numpy array
        image_np = np.array(image)
    else:
        # Se j√° √© numpy array
        image_np = image
    
    # Verificar n√∫mero de canais
    if len(image_np.shape) == 3:
        if image_np.shape[2] == 4:  # RGBA
            # Converter RGBA para RGB removendo canal alpha
            image_np = image_np[:, :, :3]
        elif image_np.shape[2] != 3:
            # Se n√£o √© RGB nem RGBA, for√ßar para 3 canais
            if image_np.shape[2] == 1:  # Grayscale
                image_np = np.repeat(image_np, 3, axis=2)
    
    # Garantir que est√° no formato correto (height, width, 3)
    if len(image_np.shape) == 2:  # Grayscale sem dimens√£o de canal
        image_np = np.stack([image_np] * 3, axis=-1)
    
    # Verifica√ß√£o final
    if image_np.shape[2] != 3:
        raise ValueError(f"Erro: Imagem tem {image_np.shape[2]} canais, YOLO precisa de 3 canais RGB")
    
    return image_np

def main():
    st.set_page_config(
        page_title="IdeaTec Tecnologia - Mottu Vision",
        page_icon="üèçÔ∏è",
        layout="wide",
        initial_sidebar_state="expanded"
    )
    
    # CSS personalizado IdeaTec
    st.markdown("""
    <style>
    .main-header {
        background: linear-gradient(90deg, #FF6B6B, #4ECDC4);
        padding: 1rem;
        border-radius: 10px;
        color: white;
        text-align: center;
        margin-bottom: 2rem;
    }
    .ideatec-box {
        background: #f0f2f6;
        padding: 1rem;
        border-radius: 10px;
        border-left: 5px solid #FF6B6B;
    }
    </style>
    """, unsafe_allow_html=True)
    
    # Header principal IdeaTec
    st.markdown('''
    <div class="main-header">
        <h1>üèçÔ∏è IdeaTec Tecnologia - Mottu Vision System</h1>
        <p>Sistema Inteligente de Detec√ß√£o e Gest√£o de Motos</p>
        <p><strong>Cliente:</strong> Mottu | <strong>Projeto:</strong> Mapeamento Inteligente do P√°tio</p>
    </div>
    ''', unsafe_allow_html=True)
    
    # Sidebar IdeaTec
    st.sidebar.header("‚öôÔ∏è Configura√ß√µes IdeaTec")
    st.sidebar.markdown("**Especialistas em Vis√£o Computacional**")
    
    confidence_threshold = st.sidebar.slider("Confian√ßa M√≠nima", 0.1, 1.0, 0.4, 0.1)
    max_frames = st.sidebar.slider("M√°ximo de Frames", 50, 500, 200, 50)
    
    st.sidebar.markdown("---")
    st.sidebar.markdown("**üè¢ IdeaTec Tecnologia**")
    st.sidebar.markdown("üìß contato@ideatec.tech")
    st.sidebar.markdown("üåê www.ideatec.tech")
    
    # Inicializar componentes
    @st.cache_resource
    def load_detector():
        return MottuMotorcycleDetector()
    
    @st.cache_resource  
    def load_iot_simulator():
        return MottuIoTSimulator()
    
    detector = load_detector()
    detector.confidence_threshold = confidence_threshold
    iot_simulator = load_iot_simulator()
    
    # Tabs principais
    tab1, tab2, tab3, tab4, tab5 = st.tabs([
        "üì∑ Detec√ß√£o de Imagens", 
        "üé• Processamento de V√≠deo", 
        "üì° Simula√ß√£o IoT", 
        "üìä Analytics & Relat√≥rios",
        "‚ÑπÔ∏è IdeaTec Tecnologia"
    ])
    
    with tab1:
        st.header("üñºÔ∏è Detec√ß√£o Inteligente de Motos - IdeaTec")
        
        uploaded_file = st.file_uploader(
            "üì§ Fa√ßa upload de uma imagem do p√°tio Mottu",
            type=['jpg', 'jpeg', 'png'],
            help="Sistema IdeaTec otimizado para p√°tios de motos"
        )
        
        if uploaded_file is not None:
            try:
                # Carregar imagem
                image = Image.open(uploaded_file)
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.subheader("üì∑ Imagem Original")
                    # CORRE√á√ÉO: usar use_container_width ao inv√©s de use_column_width
                    st.image(image, use_container_width=True)
                    st.info(f"**Dimens√µes:** {image.width} x {image.height} pixels")
                    
                    # Mostrar informa√ß√µes de canal
                    if hasattr(image, 'mode'):
                        st.info(f"**Formato:** {image.mode}")
                
                with col2:
                    st.subheader("üéØ An√°lise IdeaTec")
                    
                    with st.spinner("üîç IdeaTec analisando imagem..."):
                        # CORRE√á√ÉO: Processar imagem para garantir compatibilidade com YOLO
                        image_processed = process_image_for_yolo(image)
                        
                        # Verificar se processamento foi bem-sucedido
                        st.success(f"‚úÖ Imagem processada: {image_processed.shape[2]} canais")
                        
                        # Detectar motos
                        frame_info = detector.detect_and_classify_motorcycles(image_processed)
                        annotated_image = detector.draw_detections_professional_style(image_processed, frame_info)
                    
                    # CORRE√á√ÉO: usar use_container_width
                    st.image(annotated_image, use_container_width=True)
                    
                    # M√©tricas IdeaTec
                    col2_1, col2_2, col2_3 = st.columns(3)
                    with col2_1:
                        st.metric("üèçÔ∏è Motos Detectadas", frame_info['motorcycles_count'])
                    with col2_2:
                        st.metric("üöó Total Ve√≠culos", frame_info['total_detections'])
                    with col2_3:
                        st.metric("‚ö° Tempo Proc.", f"{frame_info['processing_time']}s")
                
                # Detalhes IdeaTec
                if frame_info['detections']:
                    st.subheader("üìã An√°lise Detalhada IdeaTec")
                    
                    detection_df = pd.DataFrame([
                        {
                            'ID Mottu': det['id'],
                            'Tipo': det['class'],
                            'Modelo': det.get('modelo_mottu', 'N/A'),
                            'Confian√ßa': f"{det['confidence']:.2%}",
                            'Zona P√°tio': det.get('zona_patio', 'N/A'),
                            'Posi√ß√£o X': det['center'][0],
                            'Posi√ß√£o Y': det['center'][1]
                        }
                        for det in frame_info['detections']
                    ])
                    
                    st.dataframe(detection_df, use_container_width=True)
                
            except Exception as e:
                st.error(f"‚ùå Erro ao processar imagem: {str(e)}")
                st.info("üí° Tente usar uma imagem JPG sem transpar√™ncia ou uma imagem PNG com 3 canais")
    
    with tab2:
        st.header("üé¨ Processamento de V√≠deo IdeaTec")
        
        video_file = st.file_uploader(
            "üìπ Upload v√≠deo do p√°tio Mottu",
            type=['mp4', 'avi', 'mov'],
            help="Sistema IdeaTec para an√°lise de v√≠deos em tempo real"
        )
        
        if video_file is not None:
            st.info(f"üìÅ **Arquivo:** {video_file.name} ({video_file.size / 1024 / 1024:.1f} MB)")
            
            if st.button("üöÄ Processar com IdeaTec", type="primary"):
                temp_video_path = f"temp_{video_file.name}"
                with open(temp_video_path, "wb") as f:
                    f.write(video_file.read())
                
                processor = MottuVideoProcessor(detector)
                
                with st.spinner(f"‚öôÔ∏è IdeaTec processando {max_frames} frames..."):
                    progress_bar = st.progress(0)
                    status_text = st.empty()
                    
                    try:
                        for i in range(max_frames):
                            progress = (i + 1) / max_frames
                            progress_bar.progress(progress)
                            status_text.text(f"IdeaTec processando frame {i+1}/{max_frames}")
                            time.sleep(0.01)
                        
                        output_path = f"output_{video_file.name}"
                        report = processor.process_patio_video(temp_video_path, output_path, max_frames)
                        
                        st.success("‚úÖ Processamento IdeaTec conclu√≠do!")
                        
                        summary = report['summary']
                        col3, col4, col5, col6 = st.columns(4)
                        with col3:
                            st.metric("üéûÔ∏è Frames", summary['total_frames_processed'])
                        with col4:
                            st.metric("üèçÔ∏è Motos", summary['total_motorcycles_detected'])
                        with col5:
                            st.metric("üìä FPS M√©dio", summary['average_fps'])
                        with col6:
                            st.metric("‚è±Ô∏è Tempo Total", f"{summary['total_processing_time']}s")
                        
                        if 'timeline' in report:
                            fig = px.line(
                                x=list(range(len(report['timeline']))),
                                y=report['timeline'],
                                title="üìà An√°lise Temporal IdeaTec - Motos por Frame",
                                labels={'x': 'Frame', 'y': 'N√∫mero de Motos'}
                            )
                            st.plotly_chart(fig, use_container_width=True)
                        
                    except Exception as e:
                        st.error(f"‚ùå Erro no processamento IdeaTec: {str(e)}")
                    finally:
                        if os.path.exists(temp_video_path):
                            os.remove(temp_video_path)
    
    with tab3:
        st.header("üì° Simula√ß√£o IoT IdeaTec")
        
        col1, col2 = st.columns([1, 1])
        
        with col1:
            st.subheader("üöÄ Controle IdeaTec")
            
            if st.button("‚ñ∂Ô∏è Iniciar Simula√ß√£o IdeaTec", type="primary"):
                with st.spinner("üîÑ IdeaTec gerando dados simulados..."):
                    simulation_thread = threading.Thread(
                        target=iot_simulator.simulate_real_time_data,
                        args=(10,)
                    )
                    simulation_thread.start()
                    time.sleep(12)
                
                st.success("‚úÖ Simula√ß√£o IdeaTec conclu√≠da!")
        
        with col2:
            st.subheader("üìä Status Frota Mottu")
            
            fleet_status = iot_simulator.get_current_fleet_status()
            
            col2_1, col2_2 = st.columns(2)
            with col2_1:
                st.metric("üèçÔ∏è Total Motos", fleet_status['total_motos'])
            with col2_2:
                available = fleet_status['fleet_summary'].get('disponivel', 0)
                st.metric("‚úÖ Dispon√≠veis", available)
            
            status_data = fleet_status['fleet_summary']
            if status_data:
                fig = px.pie(
                    values=list(status_data.values()),
                    names=list(status_data.keys()),
                    title="üìä IdeaTec - Status da Frota Mottu"
                )
                st.plotly_chart(fig, use_container_width=True)
        
        st.subheader("üóÇÔ∏è Monitoramento IdeaTec - Frota Detalhada")
        
        fleet_df = pd.DataFrame([
            {
                'ID Mottu': moto['id'],
                'Modelo': moto['model'],
                'Status': moto['status'],
                'Bateria (%)': moto['battery_level'],
                'Combust√≠vel (%)': moto['fuel_level'],
                'Zona': moto['position']['zone'],
                'Posi√ß√£o X': moto['position']['x'],
                'Posi√ß√£o Y': moto['position']['y'],
                'Od√¥metro (km)': moto['odometer']
            }
            for moto in fleet_status['motos_data']
        ])
        
        st.dataframe(fleet_df, use_container_width=True)
    
    with tab4:
        st.header("üìà Analytics IdeaTec")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.subheader("üéØ M√©tricas de Detec√ß√£o")
            
            if detector.detection_history:
                detection_report = detector.generate_sistema_report()
                summary = detection_report['sistema_summary']
                
                st.metric("üìä Frames Processados", summary['total_frames_processed'])
                st.metric("üèçÔ∏è Motos Detectadas", summary['total_motorcycles_detected'])
                st.metric("‚ö° FPS M√©dio", summary['average_fps'])
                st.metric("üéØ Precis√£o", summary['detection_accuracy_estimate'])
                
                with st.expander("üìÑ Relat√≥rio Completo IdeaTec"):
                    st.json(detection_report)
            else:
                st.info("‚ÑπÔ∏è Execute detec√ß√µes para visualizar m√©tricas IdeaTec")
        
        with col2:
            st.subheader("üè≠ Analytics Frota IoT")
            
            fleet_status = iot_simulator.get_current_fleet_status()
            
            battery_data = [moto['battery_level'] for moto in fleet_status['motos_data']]
            fuel_data = [moto['fuel_level'] for moto in fleet_status['motos_data']]
            
            fig_battery = px.histogram(
                x=battery_data,
                nbins=10,
                title="üìã IdeaTec - N√≠veis de Bateria",
                labels={'x': 'N√≠vel da Bateria (%)', 'y': 'Quantidade'}
            )
            st.plotly_chart(fig_battery, use_container_width=True)
        
        # Mapa digital do p√°tio
        st.subheader("üó∫Ô∏è Mapa Digital IdeaTec - P√°tio Mottu")
        
        patio_data = []
        for moto in fleet_status['motos_data']:
            patio_data.append({
                'x': moto['position']['x'],
                'y': moto['position']['y'],
                'id': moto['id'],
                'status': moto['status'],
                'battery': moto['battery_level']
            })
        
        if patio_data:
            patio_df = pd.DataFrame(patio_data)
            
            fig_patio = px.scatter(
                patio_df,
                x='x',
                y='y',
                color='status',
                size='battery',
                hover_data=['id', 'battery'],
                title="üèçÔ∏è IdeaTec - Posicionamento Inteligente das Motos",
                labels={'x': 'Posi√ß√£o X', 'y': 'Posi√ß√£o Y'}
            )
            
            fig_patio.update_layout(
                xaxis=dict(range=[0, 800]),
                yaxis=dict(range=[0, 600]),
                height=400
            )
            
            st.plotly_chart(fig_patio, use_container_width=True)
    
    with tab5:
        st.header("‚ÑπÔ∏è IdeaTec Tecnologia")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.subheader("üéØ Sobre a IdeaTec")
            st.write("""
            **IdeaTec Tecnologia** √© uma empresa especializada em solu√ß√µes de **Vis√£o Computacional** 
            e **Internet das Coisas (IoT)**, focada em transformar desafios operacionais em 
            oportunidades tecnol√≥gicas.
            
            **Especialidades:**
            - ‚úÖ Vis√£o Computacional com IA
            - ‚úÖ Sistemas IoT integrados
            - ‚úÖ An√°lise de dados em tempo real
            - ‚úÖ Dashboards operacionais
            - ‚úÖ Solu√ß√µes escal√°veis
            """)
            
            st.subheader("üõ†Ô∏è Tecnologias IdeaTec")
            st.write("""
            **Stack Tecnol√≥gico:**
            - ü§ñ YOLOv8 para detec√ß√£o avan√ßada
            - üëÅÔ∏è OpenCV para processamento de imagem
            - üêç Python para desenvolvimento
            - üì° MQTT para comunica√ß√£o IoT
            - üåê Streamlit para interfaces web
            - üìä Plotly para visualiza√ß√µes
            """)
        
        with col2:
            st.subheader("ü§ù Projeto Mottu")
            st.write("""
            **Cliente:** Mottu - L√≠der em Mobilidade Urbana
            
            **Desafio:** Gest√£o manual de frotas em +100 filiais 
            gerando imprecis√µes operacionais cr√≠ticas.
            
            **Solu√ß√£o IdeaTec:**
            - üèçÔ∏è Detec√ß√£o inteligente de motos
            - üó∫Ô∏è Mapeamento digital de p√°tios
            - üì± Interface web responsiva
            - üì° Simula√ß√£o IoT real√≠stica
            - üìä Analytics operacionais
            """)
            
            st.subheader("üìà Resultados Esperados")
            st.write("""
            **Benef√≠cios para Mottu:**
            - üìä 60% redu√ß√£o tempo de localiza√ß√£o
            - üéØ 95%+ precis√£o no invent√°rio
            - üöÄ Escalabilidade para 100+ filiais
            - üí∞ ROI estimado em 18 meses
            - ‚ö° Opera√ß√£o em tempo real
            """)
        
        st.success("""
        üí° **IdeaTec Tecnologia** - Transformando o futuro da gest√£o de frotas atrav√©s de 
        tecnologias disruptivas de Vis√£o Computacional e IoT.
        """)

if __name__ == "__main__":
    main()
